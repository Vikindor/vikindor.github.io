name: Update project metrics

on:
  schedule:
    - cron: '0 3 * * 1'   # Every Monday at 03:00 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch metrics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          PROJECTS_FILE="data/projects.json"
          OUTPUT_FILE="data/metrics.json"

          mkdir -p data
          echo '{}' > "$OUTPUT_FILE"

          PROJECT_IDS=$(jq -r 'keys[]' "$PROJECTS_FILE")

          for ID in $PROJECT_IDS; do
            GH_REPO=$(jq -r ".\"$ID\".github // empty" "$PROJECTS_FILE")
            GF_URL=$(jq -r ".\"$ID\".greasyfork // empty" "$PROJECTS_FILE")
            OUJS_URL=$(jq -r ".\"$ID\".openuserjs // empty" "$PROJECTS_FILE")

            STARS=0
            if [ -n "$GH_REPO" ]; then
              STARS=$(curl -s \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/$GH_REPO \
                | jq -r '.stargazers_count // 0' 2>/dev/null)

              [[ "$STARS" =~ ^[0-9]+$ ]] || STARS=0
            fi

            GF=0
            OUJS=0

            if [ -n "$GF_URL" ]; then
              GF=$(curl -s "$GF_URL" | jq -r '.total_installs // 0' 2>/dev/null)
              [[ "$GF" =~ ^[0-9]+$ ]] || GF=0
            fi

            if [ -n "$OUJS_URL" ]; then
              OUJS=$(curl -s "$OUJS_URL" | jq -r '.OpenUserJS.installs[0].value // 0' 2>/dev/null)
              [[ "$OUJS" =~ ^[0-9]+$ ]] || OUJS=0
            fi

            INSTALLS_TOTAL=$((GF + OUJS))

            jq --arg id "$ID" \
               --argjson stars "$STARS" \
               --argjson gf "$GF" \
               --argjson oujs "$OUJS" \
               --argjson total "$INSTALLS_TOTAL" \
               '
               . + {
                 ($id): {
                   stars: $stars,
                   installs: {
                     greasyfork: $gf,
                     openuserjs: $oujs,
                     total: $total
                   }
                 }
               }
               ' "$OUTPUT_FILE" > tmp.json && mv tmp.json "$OUTPUT_FILE"
          done

      - name: Commit metrics
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/metrics.json
          git commit -m "chore: update project metrics" || exit 0
          git push
